
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A Kubernetes deployment as code to OVH or Scaleway, with Prometheus, ArgoCD, Velero and Hashicorp Vault">
      
      
        <meta name="author" content="Open FUN (France Universite Numerique)">
      
      
        <link rel="canonical" href="https://openfun.github.io/kubic/argocd/">
      
      
        <link rel="prev" href="../hashicorp-vault/">
      
      
        <link rel="next" href="../velero/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>ArgoCD - Kubic</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#argocd" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kubic" class="md-header__button md-logo" aria-label="Kubic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ArgoCD
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfun/kubic/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    openfun/kubic
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kubic" class="md-nav__button md-logo" aria-label="Kubic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Kubic
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfun/kubic/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    openfun/kubic
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Deployments
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Deployments
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-manual/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manual
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-auto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automatic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hashicorp-vault/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hashicorp Vault
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    ArgoCD
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    ArgoCD
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-mono-repo" class="md-nav__link">
    <span class="md-ellipsis">
      The mono-repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#argocd-vault-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      ArgoCD Vault Plugin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-example-hello-world-application" class="md-nav__link">
    <span class="md-ellipsis">
      Basic example - hello-world application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argocd-vault-plugin-example-secret-helm-application" class="md-nav__link">
    <span class="md-ellipsis">
      ArgoCD Vault Plugin example - secret-helm application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-tenancy-example-external-app-application" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-tenancy example - external-app application
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../velero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Velero
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../standalone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Standalone
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-mono-repo" class="md-nav__link">
    <span class="md-ellipsis">
      The mono-repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#argocd-vault-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      ArgoCD Vault Plugin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-example-hello-world-application" class="md-nav__link">
    <span class="md-ellipsis">
      Basic example - hello-world application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argocd-vault-plugin-example-secret-helm-application" class="md-nav__link">
    <span class="md-ellipsis">
      ArgoCD Vault Plugin example - secret-helm application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-tenancy-example-external-app-application" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-tenancy example - external-app application
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="argocd">ArgoCD</h1>
<p><strong>Before reading this section, please note that disabling the installation of Hashicorp Vault will also disable the installation of ArgoCD Vault Plugin. You are still able to use ArgoCD the way you want but you will have to use your own repo structure.</strong></p>
<h2 id="the-mono-repo">The mono-repo</h2>
<p>The mono-repo is a git repository containing all the applications you want to deploy on your cluster. It is used by ArgoCD to deploy your applications. It is a good practice to have a mono-repo for each cluster you have.</p>
<p>This project shares a mono-repo structure which was specifically designed to ease the deployment of applications for new k8s users. It is available <a href="examples/argocd-repo">here</a>. However, you may be free to use your own repository structure.</p>
<p>The repostiory structure is the following :</p>
<pre><code class="language-bash">.
├── .gitignore
├── apps                                # Folder containing all the applications to declare
│   ├── external-app                    # Folder declaring the external-app application
│   │   └── test.json
│   ├── hello-world                     # Folder declaring the hello-world application
│   │   ├── preprod.json
│   │   ├── prod.json
│   │   └── staging.json
│   └── secret-helm                     # Folder declaring the secret-helm application
│       ├── base.yaml
│       ├── dev.json
│       ├── dev.yaml
│       ├── prod.json
│       └── prod.yaml
└── helm                                # Folder containing all the helm charts
    ├── hello-world                     # Folder containing the hello-world helm chart
    │   ├── .helmignore
    │   ├── Chart.yaml
    │   ├── README.md
    │   ├── templates
    │   │   ├── NOTES.txt
    │   │   ├── _helpers.tpl
    │   │   ├── deployment.yaml
    │   │   ├── service.yaml
    │   │   └── serviceaccount.yaml
    │   └── values.yaml
    └── secret-helm                     # Folder containing the secret-helm helm chart
        ├── .DS_Store
        ├── .helmignore
        ├── Chart.yaml
        ├── templates
        │   ├── .DS_Store
        │   └── secret.yaml
        └── values.yaml
</code></pre>
<h2 id="usage">Usage</h2>
<ol>
<li>Create a new repository with the same structure as the mono-repo</li>
<li>Create read credentials for the repository (see <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories/#access-token">here</a> for different providers)</li>
<li>Configure accordingly the Terraform variables <code>argocd_repo_url</code>, <code>argocd_repo_username</code> and <code>argocd_repo_password</code> (see <a href="common/variables.tf">variables.tf</a>). <strong>Terraform expects HTTP git credentials, not SSH.</strong></li>
<li>Define the variables <code>argocd_hostname</code> and <code>argocd_password</code> (see <a href="common/variables.tf">variables.tf</a>). The variable <code>argocd_password</code> is used to define the password of the <code>admin</code> user of ArgoCD. Terraform expects a <strong>hash</strong> of the password. To generate it, you can use the following command : <code>argocd account bcrypt --password P@$sw0rd</code> after installing ArgoCD CLI.</li>
</ol>
<h2 id="argocd-vault-plugin">ArgoCD Vault Plugin</h2>
<p>The ArgoCD Vault Plugin is a plugin for ArgoCD which allows to use secrets stored in Hashicorp Vault in your applications. It is installed by default on the cluster. You can fine tune its version by changing the variable <code>argocd_avp_version</code> (see <a href="common/variables.tf">variables.tf</a>). It is highly recommended to read the <a href="http://argocd-vault-plugin.readthedocs.io">documentation</a> of the plugin before using it as it has many undocumented features in this README that may suit your needs.</p>
<p>By default, ArgoCD Vault Plugin is configured to use the Kubernetes auth backend of Vault. The authentication is done with the Kubernetes service account of ArgoCD in the <code>argocd</code> namespace. The service account has read access on the path <code>kv/*</code>. We'll see later how to restrict the access to the secrets for specific applications.</p>
<p>ArgoCD Vault Plugin works by taking a directory of YAML files that have been templated out using the pattern of <code>&lt;placeholder&gt;</code> and then using the values from Vault to replace the placeholders. The plugin will then apply the YAML files to the cluster. You can use generic or inline placeholders. However, inline placeholders are more straightforward to use. An inline-path placeholder allows you to specify the path, key, and optionally, the version to use for a specific placeholder. This means you can inject values from multiple distinct secrets in your secrets manager into the same YAML.</p>
<p>Valid examples:</p>
<pre><code>- &lt;path:some/path#secret-key&gt;
- &lt;path:some/path#secret-key#version&gt;
</code></pre>
<p>If the version is omitted (first example), the latest version of the secret is retrieved.
By default, Vault creates a KV-V2 backend. For KV-V2 backends, the path needs to be specified as <code>&lt;path:${vault-kvv2-backend-path}/data/{path-to-secret}&gt;</code> where <code>vault-kvv2-backend-path</code> is the path to the KV-V2 backend and <code>path-to-secret</code> is the path to the secret in Vault.</p>
<p>Again, <strong>it is highly recommended to read the <a href="https://argocd-vault-plugin.readthedocs.io/en/stable/howitworks/">placeholders documentation</a> of the plugin before using it</strong>.</p>
<h2 id="examples">Examples</h2>
<h3 id="basic-example-hello-world-application">Basic example - hello-world application</h3>
<p>This example shows how to deploy a simple application with ArgoCD. The application is a simple nginx server. The application is deployed in 3 environments: staging, preprod and prod. The application is deployed in 3 different namespaces, one namespace per application and per environment.</p>
<p>The application is deployed with the following instructions :</p>
<ul>
<li>Add the <code>hello-world</code> helm chart to the <code>helm</code> folder of the mono-repo</li>
<li>Declare the application in the <code>apps</code> folder of the mono-repo by creating a folder named <code>hello-world</code>. <strong>Beware of the name of the folder, it must be the same as the name of the helm chart.</strong></li>
<li>Add a JSON file that fits your needs:</li>
<li>Add a JSON file per environment and name the file according to the following pattern: <code>&lt;environment&gt;.json</code>. For instance, for the staging environment, the file must be named <code>staging.json</code>.</li>
<li>Add a JSON file named after the application folder. For instance <code>hello-world.json</code>. This will create a standalone application without any environment.</li>
</ul>
<p>This file <strong>must be a valid JSON file and must contain at least</strong>:</p>
<pre><code class="language-json">{}
</code></pre>
<h3 id="argocd-vault-plugin-example-secret-helm-application">ArgoCD Vault Plugin example - secret-helm application</h3>
<p>This example shows how to use the ArgoCD Vault Plugin to deploy a helm chart with secrets stored in Hashicorp Vault. The application is a simple chart which creates a secret with with various keys and values. The application is deployed in 2 environments: dev and prod. The application is deployed in 2 different namespaces, one namespace per application and per environment.</p>
<p>The application configuration refers to specific helm values per environment. The used value files are declared for each environment using the JSON file. The JSON file must contain the following:</p>
<pre><code class="language-json">{
  &quot;valuesFiles&quot;: [&quot;&lt;path-to-values-file&gt;&quot;]
}
</code></pre>
<p>For instance, the prod environment uses the <code>prod.json</code> file with:</p>
<pre><code class="language-json">{
  &quot;valuesFiles&quot;: [&quot;base.yaml&quot;, &quot;prod.yaml&quot;]
}
</code></pre>
<h3 id="multi-tenancy-example-external-app-application">Multi-tenancy example - external-app application</h3>
<p>This example shows how to deploy an application in a multi-tenant environment. The cluster administrator is responsible for declaring the application on the cluster and the developers are responsible for maintaining the application helm chart. This is achieved by specifying the <code>externalRepoURL</code> in the JSON file.</p>
<p>For instance, the test environment uses the <code>test.json</code> file with:</p>
<pre><code class="language-json">{
  &quot;externalRepoURL&quot;: &quot;https://github.com/example/externalRepo.git&quot;
}
</code></pre>
<p>Beware the distant repository must be public or the cluster must have access to it. Please refer to the <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/private-repositories">ArgoCD documentation</a> for more information.</p>
<p>Please also note that the distant repository must have the exact same structure as the mono-repo. The distant repository must contain a <code>helm</code> folder with the helm charts and an <code>apps</code> folder with the application configuration:</p>
<pre><code class="language-bash">.
├── apps
│   └── external-app
│       └── test.yaml
└── helm
    └── external-app
        ├── .helmignore
        ├── Chart.yaml
        ├── charts
        ├── templates
        └── values.yaml
</code></pre>
<p>Just like that, the developer who controls the helm chart is able to request any secret contained in the vault just by using the correct path
of a secret in the vault. Therefore, the cluster administrator must restrict the access to the secrets for specific applications. This is achieved by following this procedure :</p>
<ol>
<li>Create a specific policy in Vault for the application which only gives access to the secrets needed by the application</li>
</ol>
<p>RW policy example :</p>
<pre><code class="language-hcl">path &quot;kv/metadata/my_app/*&quot; {
  capabilities = [&quot;list&quot;, &quot;read&quot;, &quot;delete&quot;]
}
path &quot;kv/data/my_app/*&quot; {
  capabilities = [&quot;create&quot;, &quot;update&quot;, &quot;read&quot;, &quot;delete&quot;]
}
path &quot;kv/delete/my_app/*&quot; {
  capabilities = [&quot;update&quot;]
}
path &quot;kv/undelete/my_app/*&quot; {
  capabilities = [&quot;update&quot;]
}
path &quot;kv/destroy/my_app/*&quot; {
  capabilities = [&quot;update&quot;]
}
</code></pre>
<ol>
<li>Attach the policy to the Vault Authentication Method</li>
<li>Create an ArgoCD Vault Plugin configuration secret which uses the Vault Authentication Method. Please refer to the <a href="https://argocd-vault-plugin.readthedocs.io/en/stable/backends/">ArgoCD Vault Plugin backend documentation</a> and the <a href="https://argocd-vault-plugin.readthedocs.io/en/stable/config/">ArgoCD Vault Plugin configuration documentation</a> for more information. Here is an example of a configuration secret for AppRole authentication:</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: external-vault-credentials
  namespace: argocd
type: Opaque
stringData:
  VAULT_ADDR: Your HashiCorp Vault Address
  AVP_TYPE: vault
  AVP_AUTH_TYPE: approle
  AVP_ROLE_ID: Your AppRole Role ID
  AVP_SECRET_ID: Your AppRole Secret ID
</code></pre>
<p>Beware, the secret <strong>must</strong> be created in the <code>argocd</code> namespace.</p>
<ol>
<li>Finally, reference the vault credentials secret in the JSON file:</li>
</ol>
<pre><code class="language-json">{
  &quot;vaultCredentials&quot;: &quot;external-vault-credentials&quot;
}
</code></pre>
<p>Please note that if you do not want to use external repositories, you can still declare a helm chart in the mono-repo which calls an external chart which has to be stored on a helm repository.</p>
<p>Next step → <a href="../velero/">Use Velero</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2023-present France Université Numérique
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>