#!/usr/bin/env bash

# Parse the variables.tf file and extract the variable names and descriptions
mapfile -t variable_names < <(sed -n 's/^.*variable "\(.*\)".*$/\1/p' variables.tf)
mapfile -t variable_descs < <(sed -n 's/^.*description *= *"\(.*\)".*$/\1/p' variables.tf)

# Create the terraform.tfvars file if it doesn't exist else, clean it
if [ ! -f terraform.tfvars ]; then
    touch terraform.tfvars
else
    >terraform.tfvars
fi

# Loop through each variable and prompt the user for a value
for i in "${!variable_names[@]}"; do
    var_name=${variable_names[i]}
    var_desc=${variable_descs[i]}

    # Extract the default value for the current variable (if available)
    var_default=$(sed -n "/variable \"$var_name\"/,/^}/p" variables.tf | grep "default" | sed -E 's/^.*default *= *"?([^"]*)"?.*$/\1/')

    # If a default value is available, display it to the user
    if [ -n "$var_default" ]; then
        read -p "$var_desc (default \"$var_default\", leave blank): " var_value

        # If the user entered nothing, use the default value
        if [ -z "$var_value" ]; then
            var_value="$var_default"
        fi
    else
        # Prompt the user for a value
        read -p "$var_desc: " var_value

        # If the user entered nothing and there is no default value, prompt again
        while [ -z "$var_value" ]; do
            echo
            read -p "You have to specify a value for \"$var_name\": " var_value
        done
    fi

    echo
    # Store the variable name and value in the terraform.tfvars file
    echo "$var_name=\"$var_value\"" >>terraform.tfvars
done
